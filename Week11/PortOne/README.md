# 2. í¬íŠ¸ì› ê²°ì œ ìš”ì²­

## 1. í¬íŠ¸ì› í†µí•© ê²°ì œ ì†”ë£¨ì…˜

[í¬íŠ¸ì›](https://portone.io/korea/ko)  
[ê²°ì œ ì—°ë™í•˜ê¸°](https://portone.gitbook.io/docs/console/guide/connect)  
[API Keys](https://portone.gitbook.io/docs/console/guide/api-keys)  
[ì¸ì¦ê²°ì œ ì—°ë™í•˜ê¸°](https://portone.gitbook.io/docs/auth/guide)  
[JavaScript SDK](https://portone.gitbook.io/docs/sdk/javascript-sdk)  

### í¬íŠ¸ì›

ì—¬ëŸ¬ PGì‚¬ë¥¼ í•˜ë‚˜ì˜ ê¹”ë”í•œ APIë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” í†µí•© ê²°ì œ ì†”ë£¨ì…˜  
ì˜ˆì „ì—ëŠ” `ì•„ì„í¬íŠ¸`ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì„œë¹„ìŠ¤ 

V2ê°€ ë” ì¢‹ì•„ì§€ê¸´ í–ˆì§€ë§Œ API Keyë¥¼ ì‹ ì²­í•´ì•¼ í•˜ê³  ì•„ì§ ë² íƒ€ë²„ì „ì´ê¸° ë•Œë¬¸ì— ì—¬ê¸°ì„œëŠ” V1 ì‚¬ìš© 

### ì¥ì  

* ê°€ë³ê²Œ ë¬´ë£Œë¡œ ì‹œì‘í•  ìˆ˜ ìˆìŒ(ì‚¬ì—…ìê°€ ì•„ë‹ˆì–´ë„ ë¨)
* ë³µì¡í•œ ì‹¬ì‚¬ ê³¼ì •ì„ ê±°ì¹˜ì§€ ì•Šì•„ë„ ë°”ë¡œ ê²°ì œ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŒ
* ì—¬ëŸ¬ ê²°ì œ ìˆ˜ë‹¨ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŒ 
* ë§ì€ ê¸°ì—…ì—ì„œ ì‚¬ìš© ì¤‘

### ì¸ì¦ê²°ì œ í”„ë¡œì„¸ìŠ¤

ì¸ì¦ê²°ì œ : í”íˆ ì“°ëŠ” ê²ƒ    
ë¹„ì¸ì¦ê²°ì œ : ì •ê¸° ê²°ì œ ë“±

1. ê²°ì œ ìš”ì²­ (F/Eì—ì„œ ìš”ì²­) â†’ ìš°ë¦¬ê°€ ìì£¼ ë³´ëŠ” ê²°ì œì°½ì´ ëœ¸ (ğŸ¢ í¬íŠ¸ì›ì— ìš”ì²­) 
2. ê²°ì œ ê²°ê³¼ í™•ì¸ (F/Eì—ì„œ ê²°ê³¼ ë°›ìŒ) (ğŸ¢ í¬íŠ¸ì›ì— ìš”ì²­)
3. ê²°ì œ ê¸ˆì•¡ ìœ„ë³€ì¡° ê²€ì¦ â†’ B/Eë¡œ ê²°ì œ ê²°ê³¼ë¥¼ ì „ì†¡í•˜ë©´ B/Eì—ì„œ ì²˜ë¦¬ (ğŸ‘©ğŸ»â€ğŸ’» ë°±ì—”ë“œì— ìš”ì²­)
4. ê²°ì œ ì™„ë£Œ â†’ B/Eì—ì„œ ì„±ê³µí•˜ë©´ F/EëŠ” ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™ (ğŸ‘©ğŸ»â€ğŸ’» ë°±ì—”ë“œì— ìš”ì²­)


### ì‚¬ìš© ë°©ë²• 

í¬íŠ¸ì›ì— ê°€ì…í•˜ê³ , ê´€ë¦¬ì ì½˜ì†”ë¡œ ê°€ì„œ ê¸°ë³¸ì ì¸ ì„¸íŒ…ì„ ì§„í–‰

#### 1. ê²°ì œ ì—°ë™ > ê²°ì œëŒ€í–‰ì‚¬ ì„¤ì • ë° ì¶”ê°€

![](../../images/week11_2_port_one.png)

![](../../images/week11_2_port_one2.png)

1. ì‹¤ ì—°ë™, í…ŒìŠ¤íŠ¸ ì¤‘ ì„ íƒ â†’ ì—¬ê¸°ì„œëŠ” **í…ŒìŠ¤íŠ¸** ì„ íƒ
2. PGì‚¬ ì„ íƒ â†’ ì›í•˜ëŠ” ê²ƒ ì•„ë¬´ê±°ë‚˜
3. **ì•„ì„í¬íŠ¸ ê²°ì œëª¨ë“ˆ**ì„ ëˆ„ë¥´ë©´ ì„ íƒí•œ PGì‚¬ì— ë”°ë¼ ì ì ˆí•œ ì„ íƒì§€ê°€ ë‚˜ì˜´
4. **+ ì¶”ê°€** ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìƒì„¸ ì •ë³´ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆëŠ”ë°, í…ŒìŠ¤íŠ¸ë¼ì„œ ê·¸ëƒ¥ **ì €ì¥** ë²„íŠ¼ì„ í´ë¦­
5. **PGìƒì ì•„ì´ë””** í•­ëª©ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì •ë³´ê°€ ë³µì‚¬ë¨ â‡’ ì±™ê²¨ë‘˜ ê²ƒ âœ…

ğŸ’¡ PGì‚¬ë¥¼ **ì¹´ì¹´ì˜¤í˜ì´**ë¡œ ì„ íƒí•˜ë©´ ë¶€ë‹´ ì—†ì´ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ê°•ë ¥ ì¶”ì²œ

#### 2. ìƒì  ãƒ» ê³„ì • ê´€ë¦¬ > ë‚´ ì‹ë³„ì½”ë“œ ãƒ» API Keys

**ê°€ë§¹ì  ì‹ë³„ì½”ë“œ** ë¶€ë¶„ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì½”ë“œê°€ í´ë¦½ë³´ë“œë¡œ ë³µì‚¬ë¨ â‡’ ì±™ê²¨ë‘˜ ê²ƒ âœ…

### PG 

PGë€ **Payment Gateway**ì˜ ì•½ìë¡œ, ì§€ë¶ˆì˜ ì¶œì…êµ¬ ì—­í• ì„ í•˜ëŠ” **ì˜¨ë¼ì¸ ê²°ì œëŒ€í–‰ì‚¬**  
PGì‚¬ì—ì„œëŠ” ì‚¬ì—…ìë¥¼ ëŒ€ì‹ í•˜ì—¬ ì¹´ë“œì‚¬ì™€ ê³„ì•½ì„ ë§ºê³  ê²°ì œì™€ ì •ì‚°ì„ ëŒ€í–‰í•´ì¤Œ  

<br>

## 2. ê²°ì œ ìš”ì²­

í¬íŠ¸ì› V2 SDKê°€ ë² íƒ€ë¡œ ì¶œì‹œëì§€ë§Œ, ì—¬ê¸°ì„œëŠ” V1ì„ ì‚¬ìš©

* V2 : npm, scriptë¡œ ì¶”ê°€ 
* V1 : scriptë¡œë§Œ ì¶”ê°€ 

### `index.html` íŒŒì¼ì— ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì¶”ê°€

```html
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
```

* ìˆœì„œëŠ” ìƒê´€ ì—†ì§€ë§Œ, ê°•ì˜ì—ì„œëŠ” ë§¨ ìœ„ì— ë°°ì¹˜   

### `main.tsx` íŒŒì¼ì˜ main í•¨ìˆ˜ì—ì„œ ê°€ë§¹ì  ì‹ë³„ ì½”ë“œë¥¼ ì„¸íŒ…

í¬íŠ¸ì› ì‚¬ìš©ë°©ë²•ì—ì„œ ì±™ê²¨ë‘” 2ê°€ì§€ ì½”ë“œë¥¼ ì´ìš© 

* íƒ€ì…ì„ ì§€ì •í•´ì£¼ëŠ” ë°©ë²•
* Reflect.getìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” ë°©ë²• â†’ ì—¬ê¸°ì„œëŠ” ì´ ë°©ë²• 

```tsx
Reflect.get(window, 'IMP').init('ê°€ë§¹ì _ì‹ë³„ì½”ë“œ');
```

ğŸš¨ í•´ë‹¹ ì´ˆê¸°í™” ì‘ì—…ì„ **1íšŒ ì´ìƒ** ì²˜ë¦¬ë˜ì§€ ì•Šë„ë¡ ì£¼ì˜      
â‡’ mainì—ì„œ ì²˜ë¦¬í•˜ëŠ” ì´ìœ  

### í™˜ê²½ ë³€ìˆ˜ ì„¸íŒ…  

[parcel - í™˜ê²½ ë³€ìˆ˜](https://ko.parceljs.org/env.html)

ì´ëŸ° ì •ë³´ëŠ” í™˜ê²½ë³€ìˆ˜ë¥¼ í™œìš©í•˜ë©´ í›¨ì”¬ ë” ì¢‹ìŒ   
`.env` íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ ê°œë°œí•  ë•Œ ì‚¬ìš©í•  í™˜ê²½ë³€ìˆ˜ë¥¼ ê´€ë¦¬   
í•˜ëŠ” ê¹€ì— (ì§€ê¸ˆê¹Œì§€ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ë˜) `API_BASE_URL`ë„ ê°™ì´ ì¡ì•„ì¤„ ê²ƒ 

```
API_BASE_URL=https://shop-demo-api-03.fly.dev
PORTONE_IMP=<ê°€ë§¹ì  ì‹ë³„ì½”ë“œ>
PORTONE_PG_CODE=<PGì‚¬ ì½”ë“œ>.<PGìƒì ì•„ì´ë””>
```

PGì‚¬ ì½”ë“œëŠ” í¬íŠ¸ì› ë¬¸ì„œë¥¼ ì°¸ê³ í•´ì„œ ì‘ì„± - [ê²°ì œìš”ì²­ íŒŒë¼ë¯¸í„°](https://portone.gitbook.io/docs/sdk/javascript-sdk/payrq)  

* .env : ê¸€ë¡œë²Œí•˜ê²Œ ì‚¬ìš©
* .env.local : ê°œë°œí•  ë•Œ ì‚¬ìš©

#### ê°€ë§¹ì  ì‹ë³„ ì½”ë“œë¥¼ ì„¸íŒ…í•  ë•Œ í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© 

```tsx
Reflect.get(window, 'IMP').init(process.env.PORTONE_IMP);
```

âš ï¸ Parcel ì„œë²„ ì¬ì‹œì‘í•˜ê¸° 

### `PaymentService` ìƒì„± 

* src/services

Axiosì™€ ë§ˆì°¬ê°€ì§€ë¡œ ì½”ë“œì—ì„œ í¬íŠ¸ì›ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡, `PaymentService`ë¥¼ ìƒì„± 

```tsx
const PG_CODE = process.env.PORTONE_PG_CODE || ''; // ì—†ìœ¼ë©´ ì—ëŸ¬ ë°œìƒ 

type Product = {
  name: string; // 'ã…‡ã…‡ ì™¸ 2ê±´' ê°™ì€ ì£¼ë¬¸ ìƒí’ˆëª…  
  price: number;
};

type Buyer = {
  name: string;
  email: string;
  phoneNumber: string;
  address: string;
  postalCode: string;
};

type PaymentResponse = {
  success: boolean;
  error_code: string;
  error_msg: string;
  imp_uid: string | null;
  merchant_uid: string;
}

export default class PaymentService {
  instance = Reflect.get(window, 'IMP');

  async requestPayment({ merchantId, product, buyer }: {
    merchantId: string;
    product: Product;
    buyer?: Buyer;  // ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì‚¬ìš© ì•ˆ í•¨ 
  }): Promise<{
    merchantId: string;
    transactionId: string;
  }> {
    return new Promise((resolve, reject) => {
      this.instance.request_pay({
        pg: PG_CODE,
        pay_method: 'card',
        merchant_uid: merchantId,
        name: product.name,
        amount: product.price,
        buyer_email: buyer?.email,
        buyer_name: buyer?.name,
        buyer_tel: buyer?.phoneNumber,
        buyer_addr: buyer?.address,
        buyer_postcode: buyer?.postalCode,
      }, (response: PaymentResponse) => {
        if (response.success) {
          resolve({
            merchantId: response.merchant_uid,
            transactionId: response.imp_uid ?? '',
          });
        } else {
          reject(Error(response.error_msg));
        }
      });
    });
  }
}

export const paymentService = new PaymentService();
```

* êµ¬ë§¤ì ì •ë³´ë¥¼ ì•Œë©´ ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì£¼ë¬¸ ì·¨ì†Œ ë“±ì„ ì²˜ë¦¬í•´ì¤„ ìˆ˜ ìˆìŒ

### ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‰½ê²Œ ì“¸ ìˆ˜ ìˆë„ë¡ `usePayment` hook ìƒì„± 

```tsx
export default function usePayment(cart: Cart) {
  return {
    async requestPayment() {
      const now = new Date();
      const date = now.toISOString().slice(0, 10).replace(/-/g, '');
      const time = now.getTime();
      const nonce = Math.random().toString().slice(-5);
      const merchantId = `ORDER-${date}-${time}${nonce}`;

      const result = await paymentService.requestPayment({
        merchantId,
        product: {
          name: cart.lineItems[0].product.name,
          price: cart.totalPrice,
        },
      });

      return result;
    },
  };
}
```

* merchantId : payment ID ë“±ìœ¼ë¡œ ì‚¬ìš©, ìœ ë‹ˆí¬í•´ì•¼ í•¨ 
* ì£¼ë¡œ ë‚ ì§œë¥¼ ë„£ì–´ì„œ ì‚¬ìš©
* ëŒ€ê·œëª¨ ì„œë¹„ìŠ¤ì˜ ê²½ìš° ë°€ë¦¬ì„¸ì»¨ë“œ ë‹¨ìœ„ê¹Œì§€ ê²¹ì¹  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— nonce(ëœë¤ ì„ì‹œ ê°’) ì‚¬ìš©
* slice(-5)ëŠ” ë’¤ì—ì„œë¶€í„° ì²˜ë¦¬
* íŠ¹ë³„í•œ ë¬¸ì œê°€ ì—†ì„ ê²ƒì´ë¼ëŠ” ì „ì œë¡œ ì‘ì„±í•œ ì½”ë“œ(ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œì´ ì—†ëŠ” ê²½ìš°ëŠ” ì´ë¯¸ ê±¸ëŸ¬ì¡Œë‹¤ê³  ê°€ì •) 

### `PaymentButton` ì»´í¬ë„ŒíŠ¸ ìƒì„± 

* src/components/new-order/OrderForm ì— `<PaymentButton />` ì¶”ê°€ 

```tsx
const Container = styled.div`
  p {
    margin-block: 2rem;
    color: ${(props) => props.theme.colors.primary};
    font-size: 2rem;
    font-weight: bold;
  }
`;

type PaymentButtonProps = {
  cart: Cart;
};

export default function PaymentButton({ cart }: PaymentButtonProps) {
  const navigate = useNavigate();

  const [{ valid }] = useOrderFormStore();

  const { requestPayment } = usePayment(cart);

  const [error, setError] = useState('');

  const handleClick = async () => {
    setError('');

    try {
      const { merchantId, transactionId } = await requestPayment();

      // TODO: B/Eë¡œ ì£¼ë¬¸ ë° ê²°ì œ ì •ë³´ ì „ë‹¬
        // ì£¼ë¬¸ ì •ë³´ëŠ” OrderFormì— ë“¤ì–´ê°€ ìˆìŒ 

      navigate('/order/complete');
    } catch (e) {
      if (e instanceof Error) {
        setError(e.message);
      }
    }
  };

  return (
    <Container>
      <Button onClick={handleClick} disabled={!valid}>
        ê²°ì œ
      </Button>
      {error && (
        <p>{error}</p>
      )}
    </Container>
  );
}
```

* ì—ëŸ¬ì¼ ê²½ìš°ì˜ í°íŠ¸ ìƒ‰ìƒì´ë‚˜ ì‚¬ì´ì¦ˆë¥¼ ì¡°ì ˆí•  ìˆ˜ ìˆìŒ
* ì—ëŸ¬ ì»´í¬ë„ŒíŠ¸ë¥¼ ë”°ë¡œ ë¹¼ë„ ë¨ 

> ğŸš§ **í…ŒìŠ¤íŠ¸ ê²°ì œ**   
> 
> ë°±ì—”ë“œë¡œ ì •ë³´ ì „ë‹¬í•˜ëŠ” ë¡œì§ì´ ë¯¸êµ¬í˜„ ìƒíƒœì´ì§€ë§Œ ì‘ë™ì€ í•¨  
> QR ì½”ë“œê°€ ëœ¨ê³  ìŠ¤ë§ˆíŠ¸í°ìœ¼ë¡œ ìŠ¤ìº”ì´ ê°€ëŠ¥    
> ë‹¤ë¥¸ PGì‚¬ë¡œ í•˜ë©´ ì§ì ‘ ì¹´ë“œë¥¼ ì—°ê²°í•´ì„œ ì‚¬ìš©í•´ë³¼ ìˆ˜ ìˆìŒ 
